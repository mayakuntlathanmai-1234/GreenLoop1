<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Certificates — GreenLoop</title>
  <link rel="icon" href="logo.png" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    body{font-family:Inter,system-ui,Arial;margin:0;background:#f6f8fb;color:#0f172a}
    .top{background:#fff;padding:12px 18px;box-shadow:0 6px 18px rgba(12,18,33,0.04);display:flex;align-items:center;justify-content:space-between}
    .container{max-width:980px;margin:20px auto;padding:18px}
    .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 12px 30px rgba(12,18,33,0.04);margin-bottom:12px;display:flex;gap:12px;align-items:center}
    .thumb{width:220px;height:146px;border-radius:6px;overflow:hidden;border:1px solid #eef6ee;flex:0 0 auto}
    .meta{flex:1}
    .meta h3{margin:0 0 6px 0}
    .meta p{margin:0;color:#6b7280}
    .actions{display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:#16a34a;color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e6eef0;color:#0f172a}
  </style>
</head>
<body>
  <header class="top">
    <div style="display:flex;align-items:center;gap:12px">
      <img src="logo.png" alt="" style="width:44px;height:44px;border-radius:8px">
      <div><strong>GreenLoop</strong><div style="font-size:13px;color:#6b7280">Certificates</div></div>
    </div>
    <div><a href="Home.html" style="color:#158038;text-decoration:none;font-weight:700">Back to site</a></div>
  </header>

  <main class="container" id="list">
    <!-- populated by JS -->
  </main>

  <script>
    (function(){
      const KEY = 'greenloop_certificates_v1';
      function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){return[]} }
      function save(list){ try{ localStorage.setItem(KEY, JSON.stringify(list)); }catch(e){} }

      // convert dataURL to Blob
      function dataURLtoBlob(dataurl){
        const arr = dataurl.split(',');
        const mime = (arr[0].match(/:(.*?);/) || [null,'application/octet-stream'])[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while(n--){
          u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], {type: mime});
      }

      // trigger download from a dataURL with desired filename
      function downloadDataUrl(dataUrl, filename){
        try{
          const blob = dataURLtoBlob(dataUrl);
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          // revoke after short delay to allow download to start
          setTimeout(()=> URL.revokeObjectURL(url), 1500);
          return true;
        }catch(err){
          console.warn('Download failed, opening in new tab', err);
          // fallback: open in new tab
          window.open(dataUrl, '_blank');
          return false;
        }
      }

      function render(){
        const el = document.getElementById('list');
        const items = load();
        if (!items.length){ el.innerHTML = '<div style="color:#6b7280">No certificates yet. Generate one from a course.</div>'; return; }
        el.innerHTML = items.map((c, idx)=>`
          <article class="card" data-idx="${idx}">
            <div class="thumb"><img src="${c.dataUrl}" style="width:100%;height:100%;object-fit:cover" alt="${c.id}"></div>
            <div class="meta">
              <h3>${c.name}</h3>
              <p>${c.course} · ${new Date(c.date).toLocaleString()}</p>
              <div style="margin-top:8px" class="actions">
                <button class="btn primary download-btn" data-idx="${idx}">Download</button>
                <a class="btn ghost preview-btn" href="${c.dataUrl}" target="_blank">Open</a>
                <button class="btn ghost del-btn" data-idx="${idx}" data-act="delete">Delete</button>
              </div>
            </div>
          </article>
        `).join('');
        // attach delete handlers
        el.querySelectorAll('button[data-act="delete"], .del-btn').forEach(b=>{
          b.addEventListener('click', function(){
            const idx = Number(b.getAttribute('data-idx'));
            const list = load();
            if (!confirm('Delete this certificate?')) return;
            list.splice(idx,1);
            save(list);
            render();
          });
        });
        // attach download handlers
        el.querySelectorAll('.download-btn').forEach(btn=>{
          btn.addEventListener('click', function(){
            const idx = Number(btn.getAttribute('data-idx'));
            const list = load();
            const cert = list[idx];
            if (!cert) return;
            const filename = `${cert.id}.png`;
            downloadDataUrl(cert.dataUrl, filename);
          });
        });
      }

      document.addEventListener('DOMContentLoaded', render);
      // also re-render when storage changes (other tabs)
      window.addEventListener('storage', function(e){
        if (!e.key || e.key === KEY) render();
      });
    })();
  </script>
</body>
</html>
